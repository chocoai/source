<% layout('/layouts/default.html', {title: '物流车查询单管理', libs: ['validate','dataGrid']}){ %>
<div class="main-content">
	<div class="box box-main">
		<div class="box-header with-border">
			<div class="box-title">
				<i class="fa fa-list-alt"></i> ${text(amLogistics.isNewRecord ? '新增物流车查询单' : '编辑物流车查询单')}
			</div>
			<div class="box-tools pull-right">
				<button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i></button>
			</div>
		</div>
		<#form:form id="inputForm" model="${amLogistics}" action="${ctx}/amlogistics/amLogistics/save" method="post" class="form-horizontal">
			<div class="box-body">
				<div class="form-unit">${text('基本信息')}</div>
				<!--<#form:hidden path="documentCode"/>-->
				<div class="row">

					<div class="col-xs-3">
						<div class="form-group">
							<label class="control-label col-sm-4" title="">
								<span class="required ">*</span> 单据编号：<i class="fa icon-question hide"></i></label>
							<div class="col-sm-8">
								<#form:hidden path="isNewRecord" id="isNewRecord"/>
								<#form:input path="documentCode" id="documentCode" maxlength="64" readonly="true" class="form-control required abc"/>
							</div>
						</div>
					</div>
					<div class="col-xs-3">
						<div class="form-group">
							<label class="control-label col-sm-4" title="">
								<span class="required hide">*</span> 单据状态：<i class="fa icon-question hide"></i></label>
							<div class="col-sm-8">
								<#form:input path="documentStatus" id="documentStatus" maxlength="100" readonly="true" class="form-control"/>
							</div>
						</div>
					</div>
					<div class="col-xs-3">
						<div class="form-group">
							<label class="control-label col-sm-4" title="">
								<span class="required hide">*</span> 店铺：<i class="fa icon-question hide"></i></label>
							<div class="col-sm-8">
								<#form:input path="stores" maxlength="200" readonly="true" class="form-control"/>
							</div>
						</div>
					</div>
					<div class="col-xs-3">
						<div class="form-group">
							<label class="control-label col-sm-4" title="">
								<span class="required hide">*</span> 销售出库单号：<i class="fa icon-question hide"></i></label>
							<div class="col-sm-8">
								<#form:input path="salesLibraryCode" readonly="true" maxlength="64" class="form-control"/>
							</div>
						</div>
					</div>
				</div>
				<div class="row">
					<div class="col-xs-3">
						<div class="form-group">
							<label class="control-label col-sm-4" title="">
								<span class="required hide">*</span> 运输单号：<i class="fa icon-question hide"></i></label>
							<div class="col-sm-8">
								<#form:input path="singleTranportCode" readonly="true" maxlength="64" class="form-control"/>
							</div>
						</div>
					</div>
					<div class="col-xs-3">
						<div class="form-group">
							<label class="control-label col-sm-4" title="">
								<span class="required hide">*</span> 三包师傅：<i class="fa icon-question hide"></i></label>
							<div class="col-sm-8">
								<#form:input path="maintenanceUser" readonly="true" maxlength="200" class="form-control"/>
							</div>
						</div>
					</div>
					<div class="col-xs-3">
						<div class="form-group">
							<label class="control-label col-sm-4" title="">
								<span class="required hide">*</span> 三包电话：<i class="fa icon-question hide"></i></label>
							<div class="col-sm-8">
								<#form:input path="maintenancePhone" readonly="true" maxlength="200" class="form-control"/>
							</div>
						</div>
					</div>
					<div class="col-xs-3">
						<div class="form-group">
							<label class="control-label col-sm-4" title="">
								<span class="required hide">*</span> 类型：<i class="fa icon-question hide"></i></label>
							<div class="col-sm-8">
								<#form:input path="type" maxlength="100" readonly="true" class="form-control"/>
							</div>
						</div>
					</div>
				</div>
				<div class="row">
					<div class="col-xs-3">
						<div class="form-group">
							<label class="control-label col-sm-4" title="">
								<span class="required hide">*</span> 客户：<i class="fa icon-question hide"></i></label>
							<div class="col-sm-8">
								<#form:input path="client" readonly="true" maxlength="200" class="form-control"/>
							</div>
						</div>
					</div>
					<div class="col-xs-3">
						<div class="form-group">
							<label class="control-label col-sm-4" title="">
								<span class="required hide">*</span> 收件人：<i class="fa icon-question hide"></i></label>
							<div class="col-sm-8">
								<#form:input path="recipient" readonly="true" maxlength="200" class="form-control"/>
							</div>
						</div>
					</div>
					<div class="col-xs-3">
						<div class="form-group">
							<label class="control-label col-sm-4" title="">
								<span class="required hide">*</span> 移动电话：<i class="fa icon-question hide"></i></label>
							<div class="col-sm-8">
								<#form:input path="mobilePhone" readonly="true" maxlength="200" class="form-control"/>
							</div>
						</div>
					</div>
					<div class="col-xs-3">
						<div class="form-group">
							<label class="control-label col-sm-4" title="">
								<span class="required hide">*</span> 销售员：<i class="fa icon-question hide"></i></label>
							<div class="col-sm-8">
								<#form:input path="seller" readonly="true" maxlength="200" class="form-control"/>
							</div>
						</div>
					</div>
				</div>
				<div class="row">
					<div class="col-xs-3">
						<div class="form-group">
							<label class="control-label col-sm-4" title="">
								<span class="required hide">*</span> 省份：<i class="fa icon-question hide"></i></label>
							<div class="col-sm-8">
								<#form:input path="province" readonly="true" maxlength="200" class="form-control"/>
							</div>
						</div>
					</div>
					<div class="col-xs-3">
						<div class="form-group">
							<label class="control-label col-sm-4" title="">
								<span class="required hide">*</span> 城市：<i class="fa icon-question hide"></i></label>
							<div class="col-sm-8">
								<#form:input path="city" readonly="true" maxlength="200" class="form-control"/>
							</div>
						</div>
					</div>
					<div class="col-xs-3">
						<div class="form-group">
							<label class="control-label col-sm-4" title="">
								<span class="required hide">*</span> 区县：<i class="fa icon-question hide"></i></label>
							<div class="col-sm-8">
								<#form:input path="county" readonly="true" maxlength="200" class="form-control"/>
							</div>
						</div>
					</div>
					<div class="col-xs-3">
						<div class="form-group">
							<label class="control-label col-sm-4" title="">
								<span class="required hide">*</span> 发货物流：<i class="fa icon-question hide"></i></label>
							<div class="col-sm-8">
								<#form:input path="logisticsCompany" readonly="true" maxlength="200" class="form-control"/>
							</div>
						</div>
					</div>
				</div>
				<div class="row">
					<div class="col-xs-3">
						<div class="form-group">
							<label class="control-label col-sm-4" title="">
								<span class="required hide">*</span> 配送方式：<i class="fa icon-question hide"></i></label>
							<div class="col-sm-8">
								<#form:input path="deliveryMethod" readonly="true"  maxlength="200" class="form-control"/>
							</div>
						</div>
					</div>
					<div class="col-xs-3">
						<div class="form-group">
							<label class="control-label col-sm-4" title="">
								<span class="required hide">*</span> 详细地址：<i class="fa icon-question hide"></i></label>
							<div class="col-sm-8">
								<#form:input path="address" readonly="true" maxlength="200" class="form-control"/>
							</div>
						</div>
					</div>
					<div class="col-xs-3">
						<div class="form-group">
							<label class="control-label col-sm-4" title="">
								<span class="required hide">*</span> 装车时间：<i class="fa icon-question hide"></i></label>
							<div class="col-sm-8">
								<#form:input path="loadingTime" readonly="true" maxlength="20" class="form-control"
								dataFormat="datetime" />
								<!--onclick="WdatePicker({dateFmt:'yyyy-MM-dd HH:mm',isShowClear:false});"-->

							</div>
						</div>
					</div>
					<div class="col-xs-3">
						<div class="form-group">
							<label class="control-label col-sm-4" title="">
								<span class="required hide">*</span> 是否超时：<i class="fa icon-question hide"></i></label>
							<div class="col-sm-8">
								<!--<#form:select path="isTimedOut" dictType="is_timed_out" blankOption="true" class="form-control" />-->
								<#form:input path="isTimedOut" readonly="true" maxlength="200" class="form-control"/>
							</div>
						</div>
					</div>

				</div>
				<div class="row">
					<div class="col-xs-3">
						<div class="form-group">
							<label class="control-label col-sm-4" title="">
								<span class="required hide">*</span> 处理人：<i class="fa icon-question hide"></i></label>
							<div class="col-sm-8">
								<#form:input path="processPerson" readonly="true" maxlength="200" class="form-control"/>
							</div>
						</div>
					</div>
					<div class="col-xs-3">
						<div class="form-group">
							<label class="control-label col-sm-4" title="">
								<span class="required hide">*</span> 最近修改人：<i class="fa icon-question hide"></i></label>
							<div class="col-sm-8">
								<#form:input path="modifyPerson" readonly="true" maxlength="200" class="form-control"/>
							</div>
						</div>
					</div>
					<div class="col-xs-3">
						<div class="form-group">
							<label class="control-label col-sm-4" title="">
								<span class="required hide">*</span> 最近修改时间：<i class="fa icon-question hide"></i></label>
							<div class="col-sm-8">
								<#form:input path="modifyDate" readonly="true" maxlength="20" class="form-control"
								dataFormat="datetime" />
								<!--onclick="WdatePicker({dateFmt:'yyyy-MM-dd HH:mm',isShowClear:false});"-->

							</div>
						</div>
					</div>
					<div class="col-xs-3">
						<div class="form-group">
							<label class="control-label col-sm-4" title="">
								<span class="required hide">*</span> 完成人：<i class="fa icon-question hide"></i></label>
							<div class="col-sm-8">
								<#form:input path="completionPerson" readonly="true" maxlength="200" class="form-control"/>
							</div>
						</div>
					</div>
				</div>
				<div class="row">
					<div class="col-xs-3">
						<div class="form-group">
							<label class="control-label col-sm-4" title="">
								<span class="required hide">*</span> 完成时间：<i class="fa icon-question hide"></i></label>
							<div class="col-sm-8">
								<#form:input path="completionDate" readonly="true" maxlength="20" class="form-control"
									dataFormat="datetime" />
								<!--onclick="WdatePicker({dateFmt:'yyyy-MM-dd HH:mm',isShowClear:false});"-->
							</div>
						</div>
					</div>
				</div>
				<div class="row">
					<div class="col-xs-6">
						<div class="form-group">
							<label class="control-label col-sm-2" title="">
								<span class="required hide">*</span> 处理结果：<i class="fa icon-question hide"></i></label>
							<div class="col-sm-10">
								<#form:textarea path="processResult" id="processResult"   rows="4" maxlength="2000" class="form-control"/>
							</div>
						</div>
					</div>
					<div class="col-xs-6">
						<div class="form-group">
							<label class="control-label col-sm-2" title="">
								<span class="required hide">*</span> 问题描述：<i class="fa icon-question hide"></i></label>
							<div class="col-sm-10">
								<#form:textarea path="problemDescription" readonly="true" rows="4" maxlength="2000" class="form-control"/>
							</div>
						</div>
					</div>
				</div>
				<h4 class="form-unit">物流车查询明细表</h4>
				<div class="ml10 mr10">
					<table id="amLogisticsDetailDataGrid"></table>
					<!--<% if (hasPermi('amlogistics:amLogistics:edit')){ %>-->
						<!--<a href="#" id="amLogisticsDetailDataGridAddRowBtn" class="btn btn-primary btn-sm mt10 mb10"><i class="fa fa-plus"></i> ${text('增行')}</a>-->
					<!--<% } %>-->
				</div>
			</div>
			<div class="box-footer">
				<div class="row">
					<div class="col-sm-offset-10 col-sm-2">
						<% if (hasPermi('amlogistics:amLogistics:edit')){ %>
							<button type="submit" class="btn btn-sm btn-primary" id="btnSubmit"><i class="fa fa-check"></i> ${text('保 存')}</button>&nbsp;
						<% } %>
						<button type="button" class="btn btn-sm btn-primary btnList" id="btnSlip"><i class="fa fa-check"></i>
							${text('转 单')}
						</button>&nbsp;
						<a href="#" onclick="save(2)"  data-title="${text('完 结')}">  <button type="submit" class="btn btn-sm btn-primary btnList" id="btnEnd"><i class="fa fa-check"></i>
							${text('完 结')}
					</div>
				</div>
			</div>
		</#form:form>
	</div>
</div>
<% var userType = 'employee'; %>
<div class="hide"><#form:listselect id="userSelect" title="用户"
	url="${ctx}/dispute/amDispute/userSelect?userType=${userType}" allowClear="false"
	checkbox="false" itemCode="userCode" itemName="userName"/></div>
<% } %>
<script>
    // 检查订单是否已结束操作
    function checkConcurrency(){
        clearInterval(this.times)
        this.times = setInterval(function(){
            $.ajax({
                url: '${ctx}/redisUnits/updataTime',
                data: {
                    'code': GetRequest().documentCode
                },
                type: 'GET',
                contentType: 'text/plain;charset=UTF-8',
                dataType: 'json'
            })
        },1000)

        // 截取url
        function GetRequest() {
            var url = location.search; //获取url中"?"符后的字串

            var theRequest = new Object();
            if (url.indexOf("?") != -1) {
                var str = url.substr(1);
                strs = (url.indexOf("&") != -1 ? str.split("&") : str.split("%26"))
                for (var i = 0; i < strs.length; i++) {
                    if (strs[i].split("=")[0] === 'beginTime') {
                        theRequest[strs[i].split("=")[0]] = turnTtime(decodeURIComponent(strs[i].split("=")[1]))
                    } else {
                        theRequest[strs[i].split("=")[0]] = decodeURIComponent(strs[i].split("=")[1]);
                    }

                }
            }
            return theRequest;
        }
    }
//初始化物流车查询明细表DataGrid对象
$("#amLogisticsDetailDataGrid").dataGrid({

	data: ${toJson(amLogistics.amLogisticsDetailList)},
	datatype: "local", // 设置本地数据
	autoGridHeight: function(){return 'auto'}, // 设置自动高度
	
	// 设置数据表格列
	columnModel: [
		{header:'状态', name:'status', editable:false, hidden:true},
		{header:'主键', name:'detailCode', editable:false, hidden:true},
		{header:'单据编码', name:'documentCode.documentCode', editable:false, hidden:true},
		{header:'物料编号', name:'consumablesCode', width:150, editable:false, edittype:'text', editoptions:{'maxlength':'64', 'class':'form-control'}},
		{header:'物料名字', name:'consumablesName', width:150, editable:false, edittype:'text', editoptions:{'maxlength':'100', 'class':'form-control'}},
		{header:'规格型号', name:'specifications', width:150, editable:false, edittype:'text', editoptions:{'maxlength':'100', 'class':'form-control'}},
		{header:'实发数量', name:'actualNumber', width:150, editable:false, edittype:'text', editoptions:{'maxlength':'20', 'class':'form-control digits'}},
		{header:'包件数', name:'packageNumber', width:150, editable:false, edittype:'text', editoptions:{'maxlength':'20', 'class':'form-control digits'}},
		{header:'是否赠品', name:'isGifts', width:150, editable:false, edittype:'text', editoptions:{'maxlength':'1', 'class':'form-control'}},
		{header:'店铺', name:'stores', width:150, editable:false, edittype:'text', editoptions:{'maxlength':'200', 'class':'form-control'}},
		{header:'销售订单号', name:'salesOrderCode', width:150, editable:false, edittype:'text', editoptions:{'maxlength':'64', 'class':'form-control'}},
		// {header:'${text('操作')}', name:'actions', width:80, sortable:false, fixed:true, formatter: function(val, obj, row, act){
		// 	var actions = [];
		// 	if (val == 'new'){
		// 		actions.push('<a href="#" onclick="js.confirm(\'${text('你确认要删除这条数据吗？')}\', function(){$(\'#amLogisticsDetailDataGrid\').dataGrid(\'delRowData\',\''+obj.rowId+'\')});return false;"><i class="fa fa-trash-o"></i></a>&nbsp;');
		// 	}else{
		// 		actions.push('<a href="#" onclick="js.confirm(\'${text('你确认要删除这条数据吗？')}\', function(){$(\'#amLogisticsDetailDataGrid\').dataGrid(\'setRowData\',\''+obj.rowId+'\',null,{display:\'none\'})});$(\'#'+obj.rowId+'_status\').val(\''+Global.STATUS_DELETE+'\');return false;"><i class="fa fa-trash-o"></i></a>&nbsp;');
		// 	}
		// 	return actions.join('');
		// }, editoptions: {defaultValue: 'new'}}
	],
	
	// 编辑表格参数
	editGrid: true,				// 是否是编辑表格
	editGridInitRowNum: 1,		// 编辑表格的初始化新增行数
	editGridAddRowBtn: $('#amLogisticsDetailDataGridAddRowBtn'),	// 子表增行按钮
	editGridAddRowInitData: {detailCode: '', status: Global.STATUS_NORMAL},	// 新增行的时候初始化的数据
	
	// 编辑表格的提交数据参数
	editGridInputFormListName: 'amLogisticsDetailList', // 提交的数据列表名
	editGridInputFormListAttrs: 'status,detailCode,documentCode.documentCode,consumablesCode,consumablesName,specifications,actualNumber,packageNumber,isGifts,stores,salesOrderCode,', // 提交数据列表的属性字段
	
	// 加载成功后执行事件
	ajaxSuccess: function(data){
        checkConcurrency()
	}
});
</script>
<script>
$("#inputForm").validate({
	submitHandler: function(form){
		js.ajaxSubmitForm($(form), function(data){
			js.showMessage(data.message);
		// 	if(data.result == Global.TRUE){
		// 		js.closeCurrentTabPage(function(contentWindow){
		// 			contentWindow.page();
		// 		});
		// 	}
            location.reload();
		}, "json");

    }
});
function open() {
    var colName = ['locationCode'];
    var url='${ctx}/locationreport/locationReport/listSelect?warehouseCode='+outWarehouseCode;
    var callback = function(val, paramName) {
        if(paramName == 'locationCode') {
            $('#' + rowId + '_outLocationCode').val(val);
        }

    }
    clickToOpenWindow(url, colName, rowId, callback);
}

var clickToOpenWindow = function(url, colName, trId, callback){
    if ($("#documentsCodeButton").hasClass("disabled")){
        return true;
    }
    var selectData = {},
        boxWidth = $(top.window).width() - 100,
        boxHeight = $(top.window).height() - 100;
    boxWidth = boxWidth < 350 ? 350 : boxWidth;
    boxHeight = boxHeight < 250 ? 250 : boxHeight;
    if(typeof listselectGetSelectData == 'function'){
        selectData = listselectGetSelectData('instorageCode'); // 如果你需要打开其他的列表，你得自己定义一个code，目前的话是打开耗材的列表
    }
    var options = {
        type: 2, // 弹窗类型，2是iframe，content必须是url，一个正常显示的页面
        maxmin: true,
        shadeClose: true,
        title: '分类编号',
        area: [boxWidth+'px', boxHeight+'px'],
        content: url,
        contentFormData: {
            checkbox: 'false',
            selectData: js.encodeUrl(JSON.stringify(selectData))
        },
        success: function(layero, index){
            if ($(js.layer.window).width() < boxWidth
                || $(js.layer.window).height() < boxHeight){
                js.layer.full(index);
            }
        },
        btn: ['<i class="fa fa-check"></i> 确定'],
        btn1: function(index, layero){
            var win = js.layer.iframeWindow(index);
            selectData = win.getSelectData();
            if(typeof listselectCheck == 'function'){
                if (!listselectCheck('instorageCode', selectData)){
                    return false;
                }
            }
            // 点击确定，获取用户选择数据
            if(typeof listselectSetSelectData == 'function'){
                listselectSetSelectData('instorageCode', selectData);
            }

            try { $('#instorageCodeCode,#instorageCodeName').valid(); }catch(e){}

            /** 传值到目标表单 START */
            var colCount = selectData.length; // 行数

            console.log(selectData)

            for (var index in selectData) { // selectData 是弹窗后选中的值
                var subItem = selectData[index]; //
                console.log(subItem);
                for(var subIndex in subItem) {

                    for(var colIndex in colName) { // 要替换的值的input name属性

                        if(subIndex == colName[colIndex]) { // 将列名称数组遍历，填充值, subIndex是选中数据的属性
                            var selector = '#' + trId + '_' + colName[colIndex];
                            var val = subItem[subIndex];
                            if(callback) { // 如果有callback，执行callback去处理
                                callback(val, subIndex);
                            } else { // 如果没有，直接用selector的定位去赋值
                                $(selector).val(val);
                            }
                        }

                    }
                }
            }
            /** END */

        }
    };
    options.btn.push('<i class="fa fa-close"></i> 关闭');
    options['btn'+options.btn.length] = function(index, layero){
        if(typeof listselectCallback == 'function'){
            listselectCallback('documentCode', 'cancel', index, layero);
        }
    };
    js.layer.open(options);
};

$('#btnSlip').click(function(){
    $('#userSelectName').click();
});
function listselectCallback(id, action, index, layero){
    if (id == 'userSelect' && action == 'ok'){
        if ($('#userSelectCode').val() != '') {
          var  documentCode=$('#documentCode').val()
            $.ajax({
                type:'POST',
                // data: $('#inputForm').serialize(),
                async:false,
                url: '${ctx}/amlogistics/amLogistics/save?flag=1&userName='+$('#userSelectName').val()+'&documentCode='+$('#documentCode').val(),
                success: function (result) {
                    result=result.split(',')
                               var message=result[1].split(':')
                               message=message[1]
                    			message=message.replace('}','')
                               // alert(message);
                               result=result[0].split(':')

                               if (result[1].toString()=='"true"'){
                                   js.closeCurrentTabPage(function(contentWindow) {
                                       contentWindow.page();
                                   })
                               }else {
                                   alert(message);
                                   location.reload();
                               }

                }
            });
        }else{
            js.showMessage('请选择用户');

        }
    }
}

function save(flag) {
    var inputForm = document.getElementById("inputForm");
        inputForm.action = '${ctx}/amlogistics/amLogistics/save?flag=2';
}
$(function() {
    var documentStatus=document.getElementById("documentStatus").value;
    if ('创建'===documentStatus){
	}else {
        document.getElementById('processResult').readOnly=true;
	}
})
</script>